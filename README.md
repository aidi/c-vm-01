# 简易虚拟机实现 (CVM-01)

这是一个用C语言实现的简易虚拟机项目，旨在展示基础的虚拟机工作原理和函数调用机制。

## 项目内容

该虚拟机实现了以下核心功能：

1. **基本指令集**：包括算术运算指令（ADD、SUB、MUL、DIV）、数据传输指令（MOV、LOAD）
2. **控制流指令**：函数调用（CALL）和返回（RET）
3. **标签系统**：支持LABEL指令定义函数标签，CALL指令通过标签名进行函数调用
4. **栈操作指令**：新增PUSH和POP指令，用于栈操作和寄存器状态管理
5. **调试功能**：寄存器打印（PRINT_INT）和断言验证（ASSERT_INT）
6. **栈管理**：用于函数调用时保存返回地址和寄存器状态
7. **函数调用机制**：支持参数传递和寄存器状态保存恢复

## 项目特点

1. **简洁高效**：使用纯C语言实现，代码结构清晰，易于理解
2. **功能完整**：实现了基础的虚拟机功能，包括寄存器操作、栈管理和函数调用
3. **可扩展性**：指令集可以方便地扩展，添加新的指令类型
4. **调试友好**：包含完整的打印和断言功能，便于调试和验证
5. **内存管理**：使用静态数组实现寄存器和栈，简化了内存管理
6. **标签系统**：支持通过标签名进行函数调用，提高代码可读性和可维护性
7. **简化的函数调用机制**：使用PUSH/POP指令显式管理寄存器状态，更加灵活

## 优点

1. **教学价值**：代码结构简单，适合学习虚拟机原理和计算机体系结构基础知识
2. **易于理解**：指令实现直观，逻辑清晰，便于初学者理解
3. **功能实用**：实现了基础的算术运算和函数调用功能，能够完成简单的计算任务
4. **代码规范**：使用清晰的注释和模块化结构，提高代码可读性
5. **错误处理**：包含基本的错误检查和断言机制，提高程序健壮性

## 缺点

1. **功能有限**：仅实现了基本指令集，缺少高级特性如条件分支、循环等
2. **性能优化**：使用数组实现栈和寄存器，在大型程序中可能存在性能瓶颈
3. **内存限制**：寄存器数量和栈大小固定，无法动态扩展
4. **缺少持久化**：不支持程序加载和保存，只能执行硬编码的指令序列
5. **错误处理简单**：在异常情况下的错误处理机制相对简单

## 快速开始

### 编译和运行

在项目目录下执行以下命令：

```bash
gcc vm-basic.c -o vm-basic
./vm-basic
```

### 示例程序

当前实现中包含了一个示例程序，演示了：
1. 基本算术运算（加、减、乘、除）
2. 函数定义和标签系统
3. 通过标签名进行函数调用
4. 使用PUSH/POP指令进行寄存器状态的保存和恢复
5. 四个基本算术函数（add、sub、mul、div）的实现和调用

## 项目结构

- `vm-basic.c`：包含虚拟机的完整实现，包括指令定义、指令序列和虚拟机执行引擎
- `vm-basic`：编译后的可执行文件

## 指令集详情

### 算术运算指令
- **ADD**：将R1和R2相加，结果存放到R1
- **SUB**：将R1减去R2，结果存放到R1
- **MUL**：将R1和R2相乘，结果存放到R1
- **DIV**：将R1除以R2，结果存放到R1

### 数据传输指令
- **LOAD**：将立即数加载到指定寄存器
- **MOV**：将源寄存器的值复制到目标寄存器

### 栈操作指令
- **PUSH**：将指定寄存器的值压入栈中
- **POP**：从栈顶弹出值到指定寄存器

### 控制流指令
- **CALL**：函数调用，将返回地址（PC+1）压入栈，并跳转到目标标签位置
- **RET**：函数返回，从栈顶弹出返回地址并设置PC
- **LABEL**：定义函数标签，用于CALL指令的跳转目标
- **EXIT**：退出虚拟机，返回指定值

### 调试指令
- **PRINT_INT**：打印指定寄存器的值
- **ASSERT_INT**：断言指定寄存器的值等于预期值

## 函数调用机制

本虚拟机实现了简洁高效的函数调用机制：

1. **标签系统**：使用LABEL指令定义函数入口点
2. **参数传递**：通过R1和R2寄存器传递参数
3. **返回值**：函数结果存放在R1寄存器中返回
4. **状态管理**：使用PUSH/POP指令显式保存和恢复寄存器状态
5. **简化的CALL实现**：仅保存返回地址到栈并跳转到目标位置
6. **简化的RET实现**：从栈顶弹出返回地址并设置PC

栈操作示例（保存和恢复寄存器）：
```c
PUSH R1  // 保存R1的值到栈
PUSH R2  // 保存R2的值到栈
// 函数体或其他操作
POP R2   // 从栈恢复R2的值
POP R1   // 从栈恢复R1的值
```

## 扩展建议

1. 添加条件分支指令（JMP、JZ、JNZ等）
2. 实现内存访问指令，支持堆内存操作
3. 添加更多寄存器，支持更复杂的程序
4. 实现指令加载功能，从文件中读取程序
5. 添加中断处理机制，支持系统调用

## 许可证

本项目采用GNU通用公共许可证（GPL v3）。详见LICENSE文件。
